library(functional) # to compose the preprocessing pipeline
library(data.table)# to read csvs
library(rlist) # for list manipulations
library(pipeR) # fast, dumb pipes
library(imputeTS) # to impute NAs
library(pander) # so i can read the output
library(foreach) # go fast
library(doParallel) # go fast

# Data import
 datadir <- "../data/"
# function which imports the data as a list, then fixes up the names to be nice
import <- function(path){
	files <- list.files(path)
	files <- files[grepl(files, pattern = ".csv")]
	filepaths <- sapply(files, function(x) paste0(path,x))
	out <- lapply(filepaths, fread)
	fnames <- gsub(".csv","",files)
	fnames <- gsub("[[:digit:]]+","", fnames)
	names(out) <- fnames
	out
}
flatten <- 
 datas <- import(datadir)
test <- datas[[1]]
#           No year month day hour season PM_Dongsi PM_Dongsihuan PM_Nongzhanguan PM_US Post
#     1:     1 2010     1   1    0      4        NA            NA              NA         NA
#     2:     2 2010     1   1    1      4        NA            NA              NA         NA
#     3:     3 2010     1   1    2      4        NA            NA              NA         NA
#     4:     4 2010     1   1    3      4        NA            NA              NA         NA
#     5:     5 2010     1   1    4      4        NA            NA              NA         NA
#    ---                                                                                    
# 52580: 52580 2015    12  31   19      4       140           157             122        133
# 52581: 52581 2015    12  31   20      4       157           199             149        169
# 52582: 52582 2015    12  31   21      4       171           231             196        203
# 52583: 52583 2015    12  31   22      4       204           242             221        212
# 52584: 52584 2015    12  31   23      4        NA            NA              NA        235
#        DEWP HUMI PRES TEMP cbwd   Iws precipitation Iprec
#     1:  -21   43 1021  -11   NW  1.79             0     0
#     2:  -21   47 1020  -12   NW  4.92             0     0
#     3:  -21   43 1019  -11   NW  6.71             0     0
#     4:  -21   55 1019  -14   NW  9.84             0     0
#     5:  -20   51 1018  -12   NW 12.97             0     0
#    ---                                                   
# 52580:   -8   68 1031   -3   SE  7.14             0     0
# 52581:   -8   63 1030   -2   SE  8.03             0     0
# 52582:  -10   73 1030   -6   NE  0.89             0     0
# 52583:  -10   73 1030   -6   NE  1.78             0     0
# 52584:   -9   79 1029   -6   NE  2.67             0     0
#     day month    No year hour season PM_Dongsi PM_Dongsihuan PM_Nongzhanguan PM_US Post DEWP
# 1     1     1  6296    2    1      4       446           389             439        432   13
# 2     2     1  6318    2    1      4       478            74              53         79    5
# 3     3     1  6342    2    1      4        94           109              99        135   40
# 4     4     1  6363    2    1      4       463           503             483        501   37
# 5     5     1  6387    2    1      4        59            72              87         93   39
# 6     6     1  6411    2    1      4        37            16              21         30   38
# 7     7     1  6435    2    1      4        95           138              84        121   37
# 8     8     1  6459    2    1      4        56           493              34         23   15
# 9     9     1  6483    2    1      4       155           429             330        428   16
# 10   10     1  6507    2    1      4       464           494             467        496   13
# 11   11     1  6526    2    1      4       487            55             496         47   11
# 12   12     1  6550    2   20      4         1           504              45         23   15
# 13   13     1  6569    2    1      4       460           444             447        489   11
# 14   14     1  6593    2    1      4        60           114              85         66   10
# 15   15     1  6616    2    1      4        20             3              13         26    5
# 16   16     1  6640    2    1      4       430           435             434        476    2
# 17   17     1  6664    2    1      4       171           152             174        219   34
# 18   18     1  6688    2    1      4        92           520             480        100   15
# 19   19     1  6712    2    1      4        42            39              49         69   40
# 20   20     1  6735    2    1      4       396             1              67         78   11
# 21   21     1  6759    2    1      4       466           504             488          1   13
# 22   22     1  6782    2    1      4        41            24              21         42   10
# 23   23     1  6804    2    1      4       160           209             217        272    8
# 24   24     1  6824    2    1      4       186           196             180        237    3
# 25   25     1  6846    2    1      4       366           341             255        440   13
# 26   26     1  6862    2    1      4       188           210             233        234   39
# 27   27     1  6882    2    1      4         3           518               3         19   39
# 28   28     1  6906    2    1      4       431            56             406        505   17
# 29   29     1  6930    2    1      4       456           480             454        485   40
# 30   30     1  6954    2    1      4       112            85             104        131    2
# 31   31     1  6978    2    1      4       198           231             354        392   38
# 32    1     2  7002    2    1      4        70            57              69         91   36
# 33    2     2  7025    2    1      4        49            17              40         50    1
# 34    3     2  7049    2    1      4       454           421              34        494   29
# 35    4     2  7072    2    1      4       221           221             221        482   26
# 36    5     2  7096    2    1      4       455           478             460        495   15
# 37    6     2  7120    2    1      4        35            22              37         58    4
# 38    7     2  7144    2    1      4       465           492             472        501   38
# 39    8     2  7168    2    1      4       465           510             481        511   37
# 40    9     2  7190    2    1      4       466           493             406         34   14
# 41   10     2  7213    2    1      4       477           221             221         23   11
# 42   11     2  7237    2    1      4       463           462             439        490    8
# 43   12     2  7258    2    1      4        98           117             128        187    5
# 44   13     2  7281    2    1      4       146           112             124        153   39
# 45   14     2  7305    2    1      4       145           135             132        181    2
# 46   15     2  7328    2    1      4       419           476             473        473   39
# 47   16     2  7352    2    1      4       362           358             359        326   38
# 48   17     2  7376    2    1      4        40            43              40         48   38
# 49   18     2  7399    2    1      4       233           255             244        200    5
# 50   19     2  7421    2    1      4       487            14               4         19    3
# 51   20     2  7445    2    1      4        24            32              35         63   38
# 52   21     2  7467    2    1      4       251           252             216        331   37
# 53   22     2  7489    2    1      4       217           238             198        315   36
# 54   23     2  7512    2    1      4       110            85             119        199   34
# 55   24     2  7534    2    1      4       148           171             165        249   36
# 56   25     2  7551    2   13      4       262           355             356        381   36
# 57   26     2  7561    2   22      4       365           357             381        427   34
# 58   27     2  7571    2    1      4        34           100             166         56   40
# 59   28     2  7593    2    1      4       307           222             266        267    4
# 60    1     3  7617    2    1      1        57            79              51         98   38
# 61    2     3  7641    2    1      1        36            26              33         38   38
# 62    3     3  7665    2    1      1       147           101             126        137   34
# 63    4     3  7688    2    1      1       174           126             161        173   40
# 64    5     3     1    1   23      1        20            74              46         57   37
# 65    6     3    16    1    1      1       161           184             114        140   37
# 66    7     3    39    1    1      1       161           156             140        155   23
# 67    8     3    62    1    1      1       367           402             325        330    1
# 68    9     3    84    1    1      1       424           524             451          7   34
# 69   10     3   107    1    1      1       221            56             221         56   11
# 70   11     3   131    1    1      1         5           508             490          8    3
# 71   12     3   155    1    1      1        18            32              26         40   34
# 72   13     3   179    1    1      1        67           166             188        145   36
# 73   14     3   203    1    1      1       457           503             447        497   23
# 74   15     3   225    1    1      1        43           108              76        106   23
# 75   16     3   247    1    1      1       261           279             265        275   41
# 76   17     3   270    1    1      1        69            92              61        130   42
# 77   18     3   292    1    1      1       353           415             396        426   61
# 78   19     3   316    1    1      1        34           222             475        256   36
# 79   20     3   338    1    1      1       334           472             407        466    1
# 80   21     3   362    1    1      1         9             9             471         17   23
# 81   22     3   386    1    1      1        69            50              64         74    1
# 82   23     3   409    1    1      1       405           449             414        416   23
# 83   24     3   433    1    1      1       454           504              12          1    8
# 84   25     3   457    1    1      1       446           501             464        507   38
# 85   26     3   479    1    1      1         2           519             498         13   39
# 86   27     3   502    1    1      1        29            19              26         37   61
# 87   28     3   526    1    1      1         1            12               1        494   10
# 88   29     3   549    1    1      1         2           521               4        509   23
# 89   30     3   571    1    1      1       424           483             451        485   37
# 90   31     3   594    1    1      1       478           519             480          7   42
# 91    1     4   617    1    1      1       132           138             151        177   61
# 92    2     4   641    1    1      1       466           329              78         34    6
# 93    3     4   659    1    1      1        40            53              40         55   12
# 94    4     4   683    1    1      1       343           370             288        311   23
# 95    5     4   707    1    1      1       480           523               9         20   63
# 96    6     4   731    1    1      1       221           421             221        482   40
# 97    7     4   754    1    1      1       375           389             365        362   39
# 98    8     4   778    1    1      1       316           466             430        458   53
# 99    9     4   801    1    1      1        45            23              12          1    5
# 100  10     4   825    1    1      1        45            23              56          1    3
# 101  11     4   849    1    1      1       222           188             166        189    5
# 102  12     4   866    1    1      1       316           330             365        311    3
# 103  13     4   887    1    1      1       450           478             457        449   42
# 104  14     4   910    1    1      1        56            23               1        460    7
# 105  15     4   932    1    1      1       418           449             375        432   23
# 106  16     4   954    1    1      1       412           436             418        449    1
# 107  17     4   975    1    1      1       418           413             407        401   41
# 108  18     4   992    1    1      1        12           100             155          1   38
# 109  19     4  1014    1    1      1       327           341             358        343    2
# 110  20     4  1033    1    1      1       432           466             430        471   42
# 111  21     4  1055    1    1      1        15            10               8         20   42
# 112  22     4  1075    1    1      1        17             4             479         17   61
# 113  23     4  1095    1    1      1        43            35             489         40   65
# 114  24     4  1117    1    1      1       150           115              16        158   65
# 115  25     4  1140    1    1      1       396           504             221        482   36
# 116  26     4  1162    1    1      1       352           429             233        334   38
# 117  27     4  1185    1    1      1       405           483             288        440    1
# 118  28     4  1205    1    1      1       472           514             468        500   62
# 119  29     4  1227    1    1      1        78           155              45         12    2
# 120  30     4  1248    1    1      1       343           144             111        289    2
# 121   1     5  1272    1    1      1       188           155              78        496   12
# 122   2     5  1296    1    1      1       343           381             298        440   42
# 123   3     5  1320    1    1      1       424           486             430        480   62
# 124   4     5  1343    1    1      1       458           488             465        484   65
# 125   5     5  1367    1    1      1        17            53              11         39   66
# 126   6     5  1391    1    1      1       207           287              55        219   48
# 127   7     5  1415    1    1      1        81           142             496         64   47
# 128   8     5  1437    1    1      1       142           337             136        138   44
# 129   9     5  1458    1    1      1       199           510             422        432   43
# 130  10     5  1481    1    1      1       473           518             470        490   44
# 131  11     5  1503    1    1      1       422           482             422        461   63
# 132  12     5  1527    1    1      1       122           483             111        245   40
# 133  13     5  1551    1    1      1       316           436             288        502   53
# 134  14     5  1575    1    1      1        85           115              91        106   46
# 135  15     5  1599    1    1      1       457           514             437        493   65
# 136  16     5  1622    1    1      1       375           462             358        393   67
# 137  17     5  1646    1    1      1       469           508             467        484   44
# 138  18     5  1660    1   22      1        52            52              50         57   47
# 139  19     5  1677    1    1      1       397           472             339        386   46
# 140  20     5  1701    1    1      1       100           133              12        167   34
# 141  21     5  1721    1    5      1        52            15             451          3   67
# 142  22     5  1733    1    1      1        47           492             437        464   66
# 143  23     5  1757    1    1      1       244           330             177        211   67
# 144  24     5  1781    1    1      1        55           129              85        118   50
# 145  25     5  1805    1    1      1       144           497             155        300   48
# 146  26     5  1829    1    1      1       481            13             476          5   51
# 147  27     5  1853    1    1      1       389           422             375        444   48
# 148  28     5  1868    1   23      1       481            19             491         26   50
# 149  29     5  1881    1    1      1       222           449             277        334    1
# 150  30     5  1905    1    1      1       334           422             358        409   67
# 151  31     5  1929    1    1      1       358           389             339        386   64
# 152   1     6  1953    1    1      2        24            33             496         25   49
# 153   2     6  1976    1    1      2       455           503             452        461   66
# 154   3     6  1999    1    1      2        64           108              60         68   50
# 155   4     6  9663    2    1      2       343           468             365        401   47
# 156   5     6  9686    2    1      2       453           502             433        432   48
# 157   6     6  2023    1   11      2        59           120             116        113   52
# 158   7     6  2028    1    1      2        30            51              61         66   52
# 159   8     6  2051    1    1      2        21            37              32         44   52
# 160   9     6  2075    1    1      2        92            47              18         77   52
# 161  10     6  2098    1    1      2       199           330             233        256   49
# 162  11     6  2122    1    1      2       244           297             266        300   49
# 163  12     6  9838    2    1      2       233           233             298        300   48
# 164  13     6  2134    1    7      2        49            53             221         28   50
# 165  14     6  9882    2    1      2       100           360             319        278   51
# 166  15     6  9906    2    1      2        33            46              28         21   51
# 167  16     6  9930    2    1      2        22            38              32         39   54
# 168  17     6  9954    2    1      2       143           136             127        136   54
# 169  18     6  2135    1   23      2       381           499             422        471   54
# 170  19     6  2144    1    1      2       469           503             478        490   51
# 171  20     6  2168    1    1      2       435           494             437        454   49
# 172  21     6  2190    1    1      2       458            42              13         27   51
# 173  22     6  2214    1    1      2       286           244             266        300   49
# 174  23     6  2237    1    1      2       446           517             470        500   51
# 175  24     6  2255    1   10      2        41           522              33         26   54
# 176  25     6  2262    1    1      2       397           381             383        416   52
# 177  26     6  2286    1    1      2       102            84              80         80   55
# 178  27     6  2307    1   18      2       487           495             471        466   52
# 179  28     6  2321    1    1      2       132           202             189        165   57
# 180  29     6  2345    1    1      2       122           319             222        267   54
# 181  30     6  2369    1    1      2       108            85              98         93   56
# 182   1     7  2382    1    1      2        69            82              81         50   57
# 183   2     7  2403    1    1      2       111           233             244        245   55
# 184   3     7  2427    1    1      2       199           188             188        234   52
# 185   4     7  2451    1    1      2       371           482             414        481   52
# 186   5     7  2475    1    1      2       144           210             199        167   51
# 187   6     7  2499    1    1      2       222           222             255        311   50
# 188   7     7  2523    1    1      2       199           370             222        300   52
# 189   8     7  2546    1    1      2         5             4               5        483   56
# 190   9     7  2570    1    1      2        80            60              54         59   58
# 191  10     7  2593    1    1      2       389           413             298        386   56
# 192  11     7  2617    1    1      2       334           277             233        289   55
# 193  12     7  2634    1   22      2       458           518             476        474   56
# 194  13     7  2651    1    1      2        41            66              37         24   56
# 195  14     7  2675    1    1      2        11            25               5        510   55
# 196  15     7  2697    1    1      2       448           511             458        483   57
# 197  16     7  2718    1    1      2       446           491             418        461   57
# 198  17     7  2742    1    1      2       275           199             188        245   51
# 199  18     7  2765    1    1      2       480            39               7          2   55
# 200  19     7  2789    1    1      2        20            14              14          9   54
# 201  20     7  2813    1    1      2        47            61              48         31   56
# 202  21     7  2836    1    1      2         5            35              14        509   56
# 203  22     7  2858    1    2      2       470           520             489        499   54
# 204  23     7  2873    1    1      2       457           508             466        484   55
# 205  24     7  2897    1    1      2       445           478             465        471   52
# 206  25     7  2913    1   23      2        67           111             111         78   50
# 207  26     7  2929    1    1      2       343           405             266        352   50
# 208  27     7  2953    1    1      2       479            11             489        500   55
# 209  28     7  2962    1    4      2       307           360             418        145   51
# 210  29     7  2963    1   13      2       327           188             430        507   56
# 211  30     7  2964    1   24      2        92           118              97         37   57
# 212  31     7  2972    1    4      2       222           370             330        278   52
# 213   1     8  2984    1    1      2       255           504             155        289   54
# 214   2     8  3003    1    1      2       468           510             454        495   54
# 215   3     8  3026    1    1      2       210           221             222        245   50
# 216   4     8  3050    1    1      2       481           505             486        489   55
# 217   5     8  3074    1    1      2       244           155             339        311   52
# 218   6     8  3089    1   24      2        79           160              93         44   57
# 219   7     8  3103    1    1      2        22           360             485        289   57
# 220   8     8  3121    1    1      2       122           221              67         89   52
# 221   9     8  3145    1    1      2       435           244             233        234   52
# 222  10     8  3165    1    1      2       456           497             453        512   57
# 223  11     8 11192    2    1      2       467           507             472        474   52
# 224  12     8  3184    1    6      2       221           507             433        432   56
# 225  13     8  3195    1    1      2       473             5             497        502   57
# 226  14     8  3217    1    1      2       465           510             472        487   52
# 227  15     8  3241    1    1      2       461             6             407        464   58
# 228  16     8  3265    1    1      2       458            85             400        440   60
# 229  17     8  3287    1    1      2        76           137              77         64   59
# 230  18     8  3311    1    1      2        23           221              23        505   47
# 231  19     8  3334    1    1      2       188           389             222        371   51
# 232  20     8  3358    1    1      2       381           482             418        449   52
# 233  21     8  3380    1    1      2        16             9              43         21   55
# 234  22     8  3403    1    1      2         7           133             497        513   51
# 235  23     8  3423    1    1      2         9            25              20         19   55
# 236  24     8  3444    1    1      2       366           436             309        487   50
# 237  25     8  3468    1    1      2       458           494             426        511   51
# 238  26     8  3492    1    1      2       426           422             437        432   50
# 239  27     8  3516    1    1      2       440           466             433        449   52
# 240  28     8  3540    1    1      2       296           288             133        300   51
# 241  29     8  3564    1    1      2        17            48               9         28   54
# 242  30     8  3588    1    1      2       221           421             221        494   43
# 243  31     8  3608    1    1      2       255           233             233        409   45
# 244   1     9  3632    1    1      3       437           491             465        490   46
# 245   2     9  3656    1    1      3       444           507             471        499   48
# 246   3     9  3680    1    1      3       480           502             474        511   50
# 247   4     9  3704    1    1      3        55            50              22         40   50
# 248   5     9  3728    1    1      3       233            23              89        100   49
# 249   6     9  3752    1    1      3       343           429             433        464   47
# 250   7     9  3776    1    1      3        11            66              39         46   49
# 251   8     9  3800    1    1      3        26            20              16         30   47
# 252   9     9  3824    1    1      3       166           405              78        432   48
# 253  10     9  3846    1    1      3       474           502             480          6   49
# 254  11     9  3863    1   24      3       471           503             494        508   45
# 255  12     9  3876    1    1      3        11             5               9         11   48
# 256  13     9  3899    1    1      3       468           483             358        501   48
# 257  14     9  3921    1    1      3        52            14              22         58   51
# 258  15     9  3945    1    1      3       296           277             309         78   66
# 259  16     9  3969    1    1      3       166           210             100        178   46
# 260  17     9  3991    1    1      3       467            44             491         35   48
# 261  18     9  4008    1    1      3        18             7             487         25   51
# 262  19     9  4032    1    1      3       471            14             487         16   50
# 263  20     9  4056    1    1      3        38            28             491         63   50
# 264  21     9  4076    1    1      3       448           523             496        491   49
# 265  22     9  4100    1    1      3       286           166             277        362   46
# 266  23     9  4124    1    1      3        41            47              57         70   49
# 267  24     9  4148    1    1      3       144           111              45        145   65
# 268  25     9  4170    1    1      3        78            45             221          1   53
# 269  26     9  4194    1    1      3       327           436             400        466   64
# 270  27     9  4217    1    1      3        30            46              46         94   67
# 271  28     9  4241    1    1      3        93            90             107        120   67
# 272  29     9  4261    1    1      3       206           172             197        201   44
# 273  30     9  4284    1   10      3       446           517             467        509   47
# 274   1    10  4291    1    1      3        61            87             106         79   48
# 275   2    10  4315    1    1      3       286           233              56        289   44
# 276   3    10  4339    1    1      3       358           405             319        352   64
# 277   4    10  4363    1    1      3       166           429             358        393   67
# 278   5    10  4387    1    1      3       306           273             336        328   45
# 279   6    10  4410    1    1      3       262           246             186        295   45
# 280   7    10  4434    1    1      3       187            97              54        107   45
# 281   8    10  4458    1    1      3       464            16             468        496   45
# 282   9    10  4476    1    1      3       487            25             493        514   67
# 283  10    10  4500    1    1      3        85            82              92        105   45
# 284  11    10  4524    1    1      3       477           360             329        145    1
# 285  12    10  4548    1    1      3       456           517             485        508   65
# 286  13    10  4572    1    1      3       478            14             478        507   43
# 287  14    10  4596    1    1      3       458            27             437        491   44
# 288  15    10  4619    1    1      3       100           266              12        167   36
# 289  16    10  4643    1    1      3       444           468             444        458    1
# 290  17    10  4653    1    4      3        40           116             117        120   61
# 291  18    10  4666    1    1      3       142           142              81        147   61
# 292  19    10  4690    1    1      3       149           176             158        182   65
# 293  20    10  4714    1    1      3        34           233              78        211    1
# 294  21    10  4737    1    1      3       444           499             456        483   53
# 295  22    10  4759    1    2      3        46            47              28         49   62
# 296  23    10  4775    1    1      3       401           494             433        454   62
# 297  24    10  4796    1    1      3       466             1              34        505    4
# 298  25    10  4813    1    1      3       307           288             288        352   34
# 299  26    10  4832    1    1      3       199           350             309        267    1
# 300  27    10  4848    1    1      3        94           107             102         73   41
# 301  28    10  4866    1    1      3       284           270             260        336   61
# 302  29    10  4881    1    1      3        95           114             121         50   63
# 303  30    10  4893    1    1      3       473           525             476          5    1
# 304  31    10  4901    1    2      3       103            65              63        139   53
# 305   1    11  4909    1    1      3       106           194             162        210   53
# 306   2    11  4933    1    1      3       114            87             109        106   62
# 307   3    11  4957    1    1      3       227           202             187        252   62
# 308   4    11  4981    1    1      3       454           133              23        156   23
# 309   5    11  5004    1    1      3        38            49              53         87    1
# 310   6    11  5028    1    1      3       178           184             181        190   42
# 311   7    11  5052    1    1      3       221           221             221        482    4
# 312   8    11  5076    1    1      3        44            77              55        107   37
# 313   9    11  5100    1    1      3        79            74              79         79   41
# 314  10    11  5124    1    1      3       221           421             463        460   21
# 315  11    11  5148    1    1      3         1           233              56        167    4
# 316  12    11  5172    1    1      3       487             6             490         29   38
# 317  13    11  5195    1    1      3       481           511             480        506   36
# 318  14    11  5218    1    1      3       128           135             130        125   12
# 319  15    11  5240    1    1      3       481           502             468        503   37
# 320  16    11  5264    1    1      3        66           125              92        130   37
# 321  17    11  5288    1    1      3        67            12               1        189    6
# 322  18    11  5312    1    1      3       466           515             488         34    6
# 323  19    11  5336    1    1      3        45            45              23         45   10
# 324  20    11  5359    1    1      3         5            14             478         43    2
# 325  21    11  5383    1    1      3        41           127             104        102   40
# 326  22    11  5405    1    1      3       110           110             106        155   38
# 327  23    11  5429    1    1      3       317           258             299        239   37
# 328  24    11  5452    1    1      3       169           119             185        169   34
# 329  25    11  5476    1    1      3       100             1              56         67    5
# 330  26    11  5499    1    1      3       440           494             414        464    2
# 331  27    11  5521    1    1      3       477           421             406        415   18
# 332  28    11  5545    1    1      3       454           221             221        415   24
# 333  29    11  5569    1    1      3       474           111             222        256   10
# 334  30    11  5593    1    1      3         4             2             486         11    4
# 335   1    12  5617    1    1      4       327           330             188        200    5
# 336   2    12  5641    1    1      4        84            96              69        133    2
# 337   3    12  5665    1    1      4        93           209             125        140    3
# 338   4    12  5689    1    1      4        74            63              62         90    2
# 339   5    12  5713    1    1      4       481            41              10         26   40
# 340   6    12  5737    1    1      4       481           497             481        507    4
# 341   7    12  5761    1    1      4       230           264             250        341   37
# 342   8    12  5785    1    1      4       324           307             323        337   12
# 343   9    12  5809    1    1      4       221           421             221        494    8
# 344  10    12  5833    1    1      4       155           503             389        428    6
# 345  11    12  5857    1    1      4       221           477             221        494   13
# 346  12    12  5881    1    1      4       405           478             439        393   10
# 347  13    12  5905    1    1      4       307           330             339        379   15
# 348  14    12  5929    1    1      4       375             2             492         27   10
# 349  15    12  5953    1    1      4       286           462             430        322   11
# 350  16    12  5977    1    1      4        82           231             230        258    6
# 351  17    12  5999    1   22      4       371           350             400        334    8
# 352  18    12  6016    1    1      4         1           504              45         23   14
# 353  19    12  6038    1   10      4       424           330             358        362   14
# 354  20    12  6045    1    1      4         9           492               8         20   11
# 355  21    12  6067    1    1      4       210           308             244        200   11
# 356  22    12  6091    1    1      4       128            97             112         86    7
# 357  23    12  6115    1    1      4       224           365             305        259    6
# 358  24    12  6139    1    1      4       154           148              99        193    6
# 359  25    12  6162    1    1      4       147           187             171        219    2
# 360  26    12  6186    1    1      4         1           329             475         56   15
# 361  27    12  6210    1    1      4        67            34              12        145   15
# 362  28    12  6232    1    4      4        45           477             406         12   17
# 363  29    12  6241    1    1      4       444           478             444        471   16
# 364  30    12  6258    1    3      4       188            89             133        267   15
# 365  31    12  6272    1    1      4        15           508             498        502   10
#     HUMI PRES TEMP cbwd  Iws precipitation Iprec
# 1      4   15   52    3  260             1     1
# 2     38   20    5    2    2             1     1
# 3     47   19   13    3 1258             1     1
# 4     66   27    1    4 1167             1     1
# 5     72   22    7    3  741             1     1
# 6     72   29    6    1    2             1     1
# 7     66   25    1    1    4             1     1
# 8     14   33    6    3  681             1     1
# 9     27   35    2    1    2             1     1
# 10    36   32   12    1    2             1     1
# 11    40   33   12    2    2             1     1
# 12    22   36   10    3  879             1     1
# 13    40   35   12    1    2             1     1
# 14    37   34   10    3    7             1     1
# 15    60   34   10    1 1060             1     1
# 16    55   29    6    4    7             1     1
# 17    80   32    1    4 1263             1     1
# 18     8   33   14    3 1107             1     1
# 19    55   31    5    4  289             1     1
# 20    17   26    1    3 1066             1     1
# 21    16   35    5    3  725             1     1
# 22    33   28    9    4    7             1     1
# 23    29   22    6    4  741             1     1
# 24    50   16    6    3  926             1     1
# 25    11   24   14    2    7             1     1
# 26    61   35    5    4  195             1     1
# 27    66   21    6    4  246             1     1
# 28     4   29   26    2  929             1     1
# 29    66   24    7    4 1123             1     1
# 30    55   15    6    1    6             1     1
# 31    61   22    1    4  913             1     1
# 32    56   20   26    2    2             1     1
# 33    80   13   26    4  719             1     1
# 34    35   24   14    2  637             1     1
# 35    88   30    8    3 1167             1     1
# 36    17   31    8    4    7             1     1
# 37    50   30    7    2  466             1     1
# 38    66   32    5    4 1435             1     1
# 39    84   26    7    4 1222             2     4
# 40    25   37   10    3 1117             1     1
# 41    40   39   12    3  718             1     1
# 42    59   32    2    1    2             1     1
# 43    65   30   11    2    2             1     1
# 44    66   37    6    4  686             1     1
# 45    60   32    7    2 1258             1     1
# 46    78   26    8    3    2             1     1
# 47    72   27    6    3  741             1     1
# 48    56   34   13    1    2             1     1
# 49    38   37    5    4 1041             1     1
# 50    47   30    5    2    7             1     1
# 51    66   31    5    4  718             1     1
# 52    84   31    7    1    1             1     1
# 53    73   30    1    3    2             1     1
# 54    62   33   26    4  141             1     1
# 55    56   31   26    2    2             1     1
# 56    78   28    5    2    2             1     1
# 57    73   24   13    3    2             1     1
# 58    24   26   52    3  243             1     1
# 59    42   29    5    2    7             1     1
# 60    61   26    1    3 1062             1     1
# 61    52   24   14    4  654             1     1
# 62    62   24   26    4  141             1     1
# 63    43   24   14    3  638             1     1
# 64    56   20   14    1    2             1     1
# 65    52   15   26    3  738             1     1
# 66    67   14   26    4    2             1     1
# 67    63    4   50    3    2             1     1
# 68    62    4   26    1    2             1     1
# 69    11   28   26    2    7             1     1
# 70    28   26   37    4 1187             1     1
# 71    38   15   53    4 1017             1     1
# 72    52   24   37    3  738             1     1
# 73    80   32   13    4  405             1     1
# 74    67   25   26    1    2             1     1
# 75    80   22   37    3  929             1     1
# 76    69   19   51    4    2             1     1
# 77    69    3   53    3  928             1     1
# 78    62   12   14    4 1096             1     1
# 79     2   23    1    4 1356            14   154
# 80    67   19   26    4  841             1     1
# 81    80   14   26    3  324             1     1
# 82    73   19   14    4 1242             1     1
# 83    17   24   26    2 1439             1     1
# 84    48   23   26    4  923             1     1
# 85    33   19   50    4  613             1     1
# 86    69   10   53    4  198             1     1
# 87     5   21   53    2  331             1     1
# 88    58   23   48    3    7             1     1
# 89    48   24   37    4  366             1     1
# 90    80   25   48    4 1096             1     1
# 91    74   16   52    1    2             1     1
# 92    15   24   51    2    7             1     1
# 93    45   12   53    1    6             1     1
# 94    44   17   52    4 1239             1     1
# 95    90   17   51    3 1054             5   134
# 96    39   24   26    2    7             1     1
# 97    30   13   51    4  609             1     1
# 98    63    9   53    3    7             1     1
# 99    13   16   53    3  541             1     1
# 100   21   23   51    3 1129             1     1
# 101   15   20   52    3  510             1     1
# 102   16   18   54    4 1356             1     1
# 103   47    7   16    2    2             1     1
# 104    5   13   17    2  287             1     1
# 105   32    7   16    4 1087             1     1
# 106   45    4   54    4 1186             1     1
# 107   50   14   54    4  948             1     1
# 108   20   18   16    3  198             1     1
# 109   17   25   54    4    7             1     1
# 110   74   24   50    4 1082             1     1
# 111   59   22   53    4    7             1     1
# 112   51   17   17    4 1228             1     1
# 113   64   13   18    4 1356             1     1
# 114   90   14   53    1  465             1     1
# 115   21   14   18    3  766             1     1
# 116   20   14   16    1    2             1     1
# 117   25   10   22    4 1046             1     1
# 118   43   14   21    4 1141             1     1
# 119    5   15   25    3  143             1     1
# 120    5   13   24    3   86             1     1
# 121   27   18   19    4   13             1     1
# 122   31   14   22    4  896             1     1
# 123   37   14   23    4 1145             1     1
# 124   55   18   21    4  747             1     1
# 125   52   17   23    4 1175             1     1
# 126   82   16   24    4    2             1     1
# 127   76   16   24    4    7             1     1
# 128   49   15   28    4 1019             1     1
# 129   52   13   25    3  738             1     1
# 130   86    8   18    4  738             1     1
# 131   34   51   25    4  588             1     1
# 132    7   49   24    3  738             1     1
# 133   33    4   22    2    2             1     1
# 134   76    5   23    2    2             1     1
# 135   41   13   25    1    2             1     1
# 136   56   19   23    4  913             1     1
# 137   56   16   25    4  994             1     1
# 138   71    9   25    4  738             1     1
# 139   71    6   24    4    7             1     1
# 140   18    5   22    1    2             1     1
# 141   28   50   33    4  741             1     1
# 142   41    8   27    1    2             1     1
# 143   52   13   24    4 1099             1     1
# 144   76   10   28    1    2             1     1
# 145   71   14   27    4    2             1     1
# 146   82   10   28    4  931             1     1
# 147   87   12   23    4 1015             1     1
# 148   87    6   25    1    7             1     1
# 149   14    9   29    3  328             1     1
# 150   45    9   27    1    2             1     1
# 151   19    4   34    4 1445             1     1
# 152   62    4   30    4    7             1     1
# 153   41    9   27    4    7             1     1
# 154   72    4   29    1    6             1     1
# 155   53    9   30    4  913             1     1
# 156   47    6   33    3    7             1     1
# 157   87    9   28    3    7             1     1
# 158   87    9   28    3  371             1     1
# 159   90   10   27    3    2             1     1
# 160   90    8   27    2    2             1     1
# 161   90   14   23    1  465             3     7
# 162   82   11   25    4  534             1     1
# 163   62    9   29    4    2             1     1
# 164   44    9   36    4  287             1     1
# 165   90    9   25    2  466             1     1
# 166   63    7   32    4  537             1     1
# 167   87    5   29    4    2             1     1
# 168   67    2   33    4 1258             1     1
# 169   63   50   34    1    6             1     1
# 170   67    2   31    4 1167             1     1
# 171   44    4   35    4    7             1     1
# 172   67   10   31    2    2             1     1
# 173   58   10   31    4 1124             1     1
# 174   87    8   27    4    2             1     1
# 175   55    1   36    4  743             1     1
# 176   87    3   28    1    2             1     1
# 177   91   51   29    4   80             1     1
# 178   87   49   28    1    2             1     1
# 179   77    1   34    4  738             1     1
# 180   87    3   29    4  738             1     1
# 181   91    6   30    3    7             1     1
# 182   87    3   32    1  465             1     1
# 183   87   46   30    3  929            29   126
# 184   51   47   36    4  841             1     1
# 185   51   47   36    3  738             1     1
# 186   72   49   30    3    7             1     1
# 187   41    1   38    4  683             1     1
# 188   72    3   31    4  929            62    56
# 189   87    2   31    3 1065             1     1
# 190   91    4   32    3    7             1     1
# 191   91    5   30    1    2             1     1
# 192   87    6   30    3  975             1     1
# 193   91    7   30    1    2             1     1
# 194   83    7   32    4  828             1     1
# 195   77    8   32    4  889             1     1
# 196   91    6   31    2    2            63   183
# 197   91   48   31    1    2             1     1
# 198   77    5   29    1    2             1     1
# 199   72    6   33    4  993             1     1
# 200   77    4   31    4  738             1     1
# 201   87    4   31    4    2             1     1
# 202   77    6   33    4 1349             1     1
# 203   72    6   32    4  632             1     1
# 204   77    3   32    1    6             1     1
# 205   72   51   31    4  892             1     1
# 206   44    3   36    3  560             1     1
# 207   54    4   33    4  936             1     1
# 208   77    3   32    2    7             1     1
# 209   39    2   40    4    7             1     1
# 210   77    1   33    2  741             1     1
# 211   73   51   35    4  741             1     1
# 212   51    1   36    4    7             1     1
# 213   87    2   29    3    7             1     1
# 214   87    6   29    1  466             1     1
# 215   54    7   33    4    7             1     1
# 216   72    3   33    4  966             1     1
# 217   83   51   29    1    2             1     1
# 218   77    1   34    1  465             1     1
# 219   77    2   34    2 1065             1     1
# 220   77    2   30    3 1100             1     1
# 221   72    1   31    3 1349             1     1
# 222   77    3   34    2    7             1     1
# 223   72    5   31    3    7             1     1
# 224   63    6   36    4  950             1     1
# 225   83    6   33    4  740             1     1
# 226   72    4   31    2  738             1     1
# 227   77    4   35    4  976             1     1
# 228   83    1   36    4  769             4    70
# 229   83   50   35    1  739             1     1
# 230   53    6   30    1    2             1     1
# 231   72   11   30    3  929             1     1
# 232   72   11   31    4 1163             1     1
# 233   83    9   31    2    7             1     1
# 234   82    8   28    4  812             1     1
# 235   87   10   30    3    7             1     1
# 236   72   11   29    4  466             1     1
# 237   77    9   29    2    7             1     1
# 238   62    5   31    1  465             1     1
# 239   72    9   31    4 1079             1     1
# 240   72    5   30    4  857             3     3
# 241   87   50   29    2    2             1     1
# 242   45   11   28    2   82             1     1
# 243   71   13   23    2    2             1     1
# 244   62   14   27    4  143             1     1
# 245   76   15   25    1    2             1     1
# 246   87   17   25    4  435             1     1
# 247   76   17   28    4  435             1     1
# 248   87   16   24    3 1349            32   138
# 249   76   17   24    4    2             1     1
# 250   82   17   25    4    7             1     1
# 251   76   18   24    1    2             1     1
# 252   71   15   27    1    6             1     1
# 253   76   13   27    4  873             1     1
# 254   53   17   28    3 1439             1     1
# 255   76   15   25    4  897             1     1
# 256   76    9   25    4  502             3    39
# 257   87    7   27    3  923             1     1
# 258   52   13   23    3 1349             1     1
# 259   71   14   24    2    7             1     1
# 260   71   13   27    4    2             1     1
# 261   87   19   27    3    7             1     1
# 262   82   17   27    4 1435             1     1
# 263   87   15   25    2    2             1     1
# 264   76   16   27    2    2             1     1
# 265   66   16   25    4  738             1     1
# 266   76   15   27    1    2             1     1
# 267   81   23   15    3  138             1     1
# 268   47   23   17    2  738             1     1
# 269   75   19   15    1    2             1     1
# 270   81   14   17    1    6             1     1
# 271   61   12   22    4  929             1     1
# 272   82   14   19    3    2             1     1
# 273   62   18   28    1    2             1     1
# 274   82   18   24    4    2             1     1
# 275   82   22   19    4    7             1     1
# 276   75   19   15    2    7             1     1
# 277   75   17   18    1    2             1     1
# 278   86   16   19    2    7             1     1
# 279   82   24   21    4    2             1     1
# 280   86   22   19    3  466             1     1
# 281   76   25   22    1  465             1     1
# 282   65   15   21    4 1356             1     1
# 283   82    9   21    2    7             1     1
# 284   36   16   17    1    7             1     1
# 285   75   18   16    2    6             1     1
# 286   65   19   22    3  741             1     1
# 287   82   20   19    1    6             1     1
# 288   44   34   50    3 1167             1     1
# 289   67   28   48    1  465             1     1
# 290   43   29   19    4  741             1     1
# 291   74   27   52    4    6             1     1
# 292   70   25   17    3    7             1     1
# 293   49   27   53    2    2             1     1
# 294   63   24   53    1  465             1     1
# 295   81   25   52    4    7             1     1
# 296   74   22   53    2 1258             1     1
# 297   15   28   53    3  858             1     1
# 298   28   29   16    3 1389             1     1
# 299   63   26   50    3  929             1     1
# 300   63   20   51    1    6             1     1
# 301   81   19   51    3    2             1     1
# 302   74   26   54    2    7             1     1
# 303   67   30   48    1    2             1     1
# 304   80   28   50    1    1             1     1
# 305   80   29   50    4    2             1     1
# 306   81   25   52    1  465             1     1
# 307   81   23   52    1    1             1     1
# 308   58   30   48    1    2             1     1
# 309   58   26   51    2    7             1     1
# 310   80   19   48    1    2             1     1
# 311   11   23   15    3  159             1     1
# 312   52   21   26    3    2             1     1
# 313   63   22   51    1  923             1     1
# 314   57   33   51    3 1286             1     1
# 315   32   31   14    3    7             1     1
# 316   52   26   14    2    7             1     1
# 317   48   26   48    4    7             1     1
# 318   62   20   48    3 1167             1     1
# 319   52   20   26    2    7             1     1
# 320   44   16   48    1    6             1     1
# 321   20   25   37    3  451             1     1
# 322   20   28   37    3  178             1     1
# 323   15   29   14    2  564             1     1
# 324   47   24    1    2    2             1     1
# 325   47   27   13    3    2             1     1
# 326   56   28   13    1    1             1     1
# 327   61   23   13    2    7             1     1
# 328   56   21   37    2    2             1     1
# 329   17   16   51    3 1016             1     1
# 330   55   18    6    1  922             1     1
# 331    7   26    5    3   93             1     1
# 332    1   30    6    3  803             1     1
# 333   10   25   48    3 1049             1     1
# 334   34   18   13    1    6             1     1
# 335   38   27    5    2    2             1     1
# 336   55   22    6    2    6             1     1
# 337   32   22   26    3  923             1     1
# 338   32   22   37    1  466             1     1
# 339   33   22   48    1    2             1     1
# 340   42   23    5    1    6             1     1
# 341   73   21    5    4    6             1     1
# 342   73   21   26    1  740             1     1
# 343   17   26   26    3 1474             1     1
# 344   38   23    6    3  466             1     1
# 345   13   24   13    3  254             1     1
# 346   24   18    6    3  741             1     1
# 347   25   26   11    1    2             1     1
# 348   37   27   10    3 1263             1     1
# 349   20   33    6    1    7             1     1
# 350   45   35    8    1    2             1     1
# 351   21   33   13    2 1065             1     1
# 352   20   38    8    2  966             1     1
# 353   14   31    5    4    2             1     1
# 354   36   33   11    3 1439             1     1
# 355   24   38    7    2 1166             1     1
# 356   54   35   11    4    2             1     1
# 357   59   32   11    2    6             1     1
# 358   50   37    9    2    2             1     1
# 359   72   32    9    3    7             1     1
# 360   14   33    6    3  259             1     1
# 361   17   35    8    3  838             1     1
# 362    7   30    1    3 1329             1     1
# 363    8   25    1    4  923             1     1
# 364    4   18   50    3 1219             1     1
# 365   21   14    5    1    2             1     1

# count the nas of a data frame
count_nas_single <- function(df){
	sapply(df, function(x) sum(is.na(x)/length(x)))

}
# count the NAs of a list
count_nas <- function(xs){
	lapply(xs, count_nas_single)
}

# pander(count_nas(datas))
# 
# 
#   * **BeijingPM_**:
# 
#     ---------------------------------------------------------------------
#      No   year   month   day   hour   season   PM_Dongsi   PM_Dongsihuan
#     ---- ------ ------- ----- ------ -------- ----------- ---------------
#      0     0       0      0     0       0       0.5236         0.61
#     ---------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     ----------------------------------------------------------------------------
#      PM_Nongzhanguan   PM_US Post     DEWP        HUMI       PRES       TEMP
#     ----------------- ------------ ----------- ---------- ---------- -----------
#          0.5259         0.04178     9.509e-05   0.006447   0.006447   9.509e-05
#     ----------------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     --------------------------------------------------
#        cbwd         Iws      precipitation    Iprec
#     ----------- ----------- --------------- ----------
#      9.509e-05   9.509e-05     0.009204      0.009204
#     --------------------------------------------------
# 
#   * **ChengduPM_**:
# 
#     ---------------------------------------------------------------------
#      No   year   month   day   hour   season   PM_Caotangsi   PM_Shahepu
#     ---- ------ ------- ----- ------ -------- -------------- ------------
#      0     0       0      0     0       0         0.5356        0.5323
#     ---------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     --------------------------------------------------------------------------
#      PM_US Post    DEWP      HUMI       PRES      TEMP       cbwd       Iws
#     ------------ --------- --------- ---------- --------- ---------- ---------
#        0.4504     0.01006   0.01017   0.009908   0.01002   0.009908   0.01014
#     --------------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     ------------------------
#      precipitation   Iprec
#     --------------- --------
#         0.0562       0.0562
#     ------------------------
# 
#   * **GuangzhouPM_**:
# 
#     --------------------------------------------------------------
#      No   year   month   day   hour    season     PM_City Station
#     ---- ------ ------- ----- ------ ----------- -----------------
#      0     0       0      0     0     1.902e-05       0.3848
#     --------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     -----------------------------------------------------------------------
#      PM_5th Middle School   PM_US Post     DEWP        HUMI        PRES
#     ---------------------- ------------ ----------- ----------- -----------
#             0.5988            0.3848     1.902e-05   1.902e-05   1.902e-05
#     -----------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     ---------------------------------------------------------------
#        TEMP        cbwd         Iws      precipitation     Iprec
#     ----------- ----------- ----------- --------------- -----------
#      1.902e-05   1.902e-05   1.902e-05     1.902e-05     1.902e-05
#     ---------------------------------------------------------------
# 
#   * **ShanghaiPM_**:
# 
#     -----------------------------------------------------------------------------
#      No   year   month   day   hour   season   PM_Jingan   PM_US Post   PM_Xuhui
#     ---- ------ ------- ----- ------ -------- ----------- ------------ ----------
#      0     0       0      0     0       0       0.5303       0.3527      0.521
#     -----------------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     -----------------------------------------------------------------------
#        DEWP        HUMI        PRES        TEMP        cbwd         Iws
#     ----------- ----------- ----------- ----------- ----------- -----------
#      0.0002472   0.0002472   0.0005325   0.0002472   0.0002282   0.0002282
#     -----------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     -------------------------
#      precipitation    Iprec
#     --------------- ---------
#         0.07624      0.07624
#     -------------------------
# 
#   * **ShenyangPM_**:
# 
#     ----------------------------------------------------------------------
#      No   year   month   day   hour   season   PM_Taiyuanjie   PM_US Post
#     ---- ------ ------- ----- ------ -------- --------------- ------------
#      0     0       0      0     0       0         0.5362         0.5877
#     ----------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     --------------------------------------------------------------------------
#      PM_Xiaoheyan    DEWP      HUMI      PRES      TEMP      cbwd       Iws
#     -------------- --------- --------- --------- --------- --------- ---------
#         0.5317      0.01316   0.01293   0.01316   0.01316   0.01316   0.01316
#     --------------------------------------------------------------------------
# 
#     Table: Table continues below
# 
# 
#     ------------------------
#      precipitation   Iprec
#     --------------- --------
#         0.2427       0.2427
#     ------------------------
# 
# 
# <!-- end of list -->
# 
# 
# NULL

# convert a vector to a time series with the proper frequency
tots <- function(v){
	ts(v, frequency = 365*24)
}
# tots(datas[[1]]$PM_US) %>>% tail

# convert a data frame into a list of time series objects, given column names
totslist <- function(df){
	badlist <- c(
		     "No",
		     "year",
		     "month",
		     "day",
		     "hour",
		     "season",
		     "cbwd"
	)
	nms <- colnames(df)
	df <- as.list(df)
	for (name in nms){
		if (name %in% badlist){
			df[[name]] <- df[[name]]
		} else {
			df[[name]]  <- tots(df[[name]])
		}
	}
	df
	

}
# datas[[1]] %>>% totsdf %>>%str
# datas[[1]] %>>% totslist%>>%str
totsall <- function(xs){
	lapply(xs, totslist)
}
# str(datas[[1]]$PM_US)
# datas %>>% totsall -> datas

# impute NAs of a single list with spline interpolation
# try na.ma but dont fail on error, instead just do standard type checking
# if the output is a time series, impute the NAs, otherwise do nothing
imp_test <- function(v){
	out <- try(na.interpolation(v, "spline"))
	ifelse(
	       is.ts(out),
	       return(out),
	       return(v)
	)
}
# impute the NAs of a single list
impute <- function(xs){
	foreach(i = 1:length(xs),
		.final = function(x){
			setNames(x, names(xs))
		}) %dopar% 
		imp_test(xs[[i]])
}
# cl <- makeCluster(11, type = "FORK")
# registerDoParallel(cl)
# na.ma(datas[[1]][["PM_"]], k=200)
# na.interpolation(datas[[1]][["PM_Dongsi"]], "spline") %>>% head
# impute(datas[[1]]) %>>% names

# impute NAs of the parent list
impute_list <- function(xs){
	lapply(xs, impute)
}

# make a fast hash table
to_hash <- function(xs){
	list2env(xs, envir = NULL, hash = TRUE)
}
# final preprocessing function:

preprocess_noisy <- Compose(import, totsall, impute_list, to_hash)



sum_or_combine <- function(x){
	ifelse(
	       is.numeric(x),
	       sum(x,na.rm = T),
	       head(x,1)
	)
}

to_days <- function(df){
	aggregate(data = df, . ~ day + month, FUN = sum_or_combine)
}

to_days_all <- function(xs){
	lapply(1:length(xs), function(x) to_days(xs[[x]]))
}


totsdaily <- function(v){
	ts(v, frequency = 365)
}
# tots(datas[[1]]$PM_US) %>>% tail

# convert a data frame into a list of time series objects, given column names
totslistd <- function(df){
	badlist <- c(
		     "No",
		     "year",
		     "month",
		     "day",
		     "hour",
		     "season",
		     "cbwd"
	)
	nms <- colnames(df)
	df <- as.list(df)
	for (name in nms){
		if (name %in% badlist){
			df[[name]] <- df[[name]]
		} else {
			df[[name]]  <- totsdaily(df[[name]])
		}
	}
	df
	

}
# datas[[1]] %>>% totsdf %>>%str
# datas[[1]] %>>% totslist%>>%str
totsall_daily <- function(xs){
	lapply(xs, totslistd)
}


preprocess_tidy <- Compose(import, to_days_all, totsall_daily, to_hash)
